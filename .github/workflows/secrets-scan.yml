# Mara Security ‚Äì Secrets Scan
# Scans repository for secrets and credentials using TruffleHog
# Fails on HIGH severity findings
# Runs on PRs and weekly schedule

name: Mara Security ‚Äì Secrets Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Tuesdays at 2 AM UTC
    - cron: '0 2 * * 2'
  workflow_dispatch:

jobs:
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest

    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_ALERTS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for secrets scanning

      - name: Run TruffleHog
        id: trufflehog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --only-verified
        continue-on-error: true

      - name: Parse TruffleHog results
        id: parse_results
        run: |
          # Check if TruffleHog found any secrets
          if [ -f trufflehog_report.json ]; then
            HIGH_SEVERITY=$(jq '[.[] | select(.Severity == "HIGH")] | length' trufflehog_report.json 2>/dev/null || echo "0")
            MEDIUM_SEVERITY=$(jq '[.[] | select(.Severity == "MEDIUM")] | length' trufflehog_report.json 2>/dev/null || echo "0")
            LOW_SEVERITY=$(jq '[.[] | select(.Severity == "LOW")] | length' trufflehog_report.json 2>/dev/null || echo "0")
          else
            HIGH_SEVERITY=0
            MEDIUM_SEVERITY=0
            LOW_SEVERITY=0
          fi
          
          echo "high_severity=$HIGH_SEVERITY" >> $GITHUB_OUTPUT
          echo "medium_severity=$MEDIUM_SEVERITY" >> $GITHUB_OUTPUT
          echo "low_severity=$LOW_SEVERITY" >> $GITHUB_OUTPUT
          
          # Fail if HIGH severity findings exist
          if [ "$HIGH_SEVERITY" -gt 0 ]; then
            echo "‚ùå Found $HIGH_SEVERITY HIGH severity secrets. Failing scan."
            exit 1
          elif [ "$MEDIUM_SEVERITY" -gt 0 ] || [ "$LOW_SEVERITY" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $MEDIUM_SEVERITY MEDIUM and $LOW_SEVERITY LOW severity findings (non-blocking)"
          else
            echo "‚úÖ No secrets found"
          fi

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: trufflehog-results
          path: |
            trufflehog_report.json
          retention-days: 7

      - name: Notify Discord (secrets scan results)
        if: always()
        continue-on-error: true
        run: |
          set +e
          
          STATUS="${{ job.status }}"
          HIGH_SEVERITY="${{ steps.parse_results.outputs.high_severity }}"
          MEDIUM_SEVERITY="${{ steps.parse_results.outputs.medium_severity }}"
          LOW_SEVERITY="${{ steps.parse_results.outputs.low_severity }}"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          
          ICON="‚úÖ"
          TITLE="Secrets Scan Completed"
          if [ "$STATUS" != "success" ]; then
            ICON="üö®"
            TITLE="Secrets Scan FAILED - HIGH Severity Findings"
          fi
          
          MESSAGE="${ICON} **${TITLE}**
          
          **Findings:**
          üî¥ HIGH: ${HIGH_SEVERITY}
          üü° MEDIUM: ${MEDIUM_SEVERITY}
          üü¢ LOW: ${LOW_SEVERITY}
          
          Branch: \`${GITHUB_REF_NAME}\`
          Actor: \`${GITHUB_ACTOR}\`
          
          View results: ${RUN_URL}"
          
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ö†Ô∏è DISCORD_WEBHOOK_ALERTS secret is not set. Skipping notification."
            exit 0
          fi
          
          PAYLOAD=$(python3 -c "import json; print(json.dumps({'content': '''$MESSAGE'''}))" 2>/dev/null)
          
          if [ $? -ne 0 ] || [ -z "$PAYLOAD" ]; then
            echo "‚ö†Ô∏è Failed to create JSON payload. Skipping notification."
            exit 0
          fi
          
          HTTP_CODE=$(curl -s -o /tmp/discord_response.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            -X POST "$DISCORD_WEBHOOK" 2>/dev/null)
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
            echo "‚úÖ Discord notification sent successfully (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Failed to send Discord notification (HTTP $HTTP_CODE)"
          fi
          
          exit 0

