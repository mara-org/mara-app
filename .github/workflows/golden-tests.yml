# Mara Tests ‚Äì Golden + Widget
# Runs golden tests for visual regression detection
# Uploads golden diffs as artifacts on failure

name: Mara Tests ‚Äì Golden + Widget

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  golden-tests:
    name: Golden Tests
    runs-on: ubuntu-latest

    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_EVENTS }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.0"

      - name: Flutter pub get
        run: flutter pub get

      - name: Run golden tests
        id: golden_tests
        continue-on-error: true
        run: |
          echo "üñºÔ∏è Running golden tests..."
          # Run all golden test files
          flutter test \
            test/ui/example_golden_test.dart \
            test/ui/welcome_golden_test.dart \
            test/ui/chat/chat_screen_golden_test.dart \
            test/ui/auth/sign_in_email_golden_test.dart || {
            echo "‚ùå Golden tests failed"
            echo "tests_passed=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Golden test failure detected. Check artifacts for diffs."
            echo "üí° To download and debug:"
            echo "   1. Go to workflow run artifacts"
            echo "   2. Download 'golden-diffs' artifact"
            echo "   3. Compare .diff.png files to see visual changes"
            exit 1
          }
          echo "‚úÖ Golden tests passed"
          echo "tests_passed=true" >> $GITHUB_OUTPUT

      - name: Upload golden diffs
        if: failure() && steps.golden_tests.outcome == 'failure'
        uses: actions/upload-artifact@v5
        with:
          name: golden-diffs
          path: |
            test/ui/**/goldens/**/*.png
            test/ui/**/goldens/**/*.diff.png
          retention-days: 7
          if-no-files-found: ignore

      - name: Display debug instructions
        if: failure() && steps.golden_tests.outcome == 'failure'
        run: |
          echo "üìã How to debug golden test failures:"
          echo "1. Download the 'golden-diffs' artifact from this workflow run"
          echo "2. Extract and examine .diff.png files to see visual changes"
          echo "3. If changes are intentional, update golden files:"
          echo "   flutter test --update-goldens test/ui/welcome_golden_test.dart"
          echo "4. Commit the updated golden files"

      - name: Notify Discord (golden test results)
        if: always()
        continue-on-error: true
        run: |
          set +e
          
          STATUS="${{ job.status }}"
          TESTS_PASSED="${{ steps.golden_tests.outputs.tests_passed }}"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          
          ICON="‚úÖ"
          TITLE="Golden Tests Passed"
          if [ "$STATUS" != "success" ]; then
            ICON="‚ö†Ô∏è"
            TITLE="Golden Tests Failed - Visual Regression Detected"
          fi
          
          MESSAGE="${ICON} **${TITLE}**
          
          Status: \`${STATUS}\`
          Branch: \`${GITHUB_REF_NAME}\`
          
          ${STATUS != 'success' ? '‚ö†Ô∏è Visual regression detected. Check artifacts for golden diffs.' : '‚úÖ All golden tests passed.'}
          
          View results: ${RUN_URL}"
          
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ö†Ô∏è DISCORD_WEBHOOK_EVENTS secret is not set. Skipping notification."
            exit 0
          fi
          
          PAYLOAD=$(python3 -c "import json; print(json.dumps({'content': '''$MESSAGE'''}))" 2>/dev/null)
          
          if [ $? -ne 0 ] || [ -z "$PAYLOAD" ]; then
            echo "‚ö†Ô∏è Failed to create JSON payload. Skipping notification."
            exit 0
          fi
          
          HTTP_CODE=$(curl -s -o /tmp/discord_response.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            -X POST "$DISCORD_WEBHOOK" 2>/dev/null)
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
            echo "‚úÖ Discord notification sent successfully (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Failed to send Discord notification (HTTP $HTTP_CODE)"
          fi
          
          exit 0

