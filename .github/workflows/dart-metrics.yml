# Mara CI ‚Äì Dart Metrics
# Runs code complexity and metrics analysis
# Provides insights into code quality and maintainability

name: Mara CI ‚Äì Dart Metrics

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  dart-metrics:
    name: Dart Code Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.0"

      - name: Flutter pub get
        run: flutter pub get

      - name: Run dart analyze
        continue-on-error: true
        run: |
          echo "üîç Running dart analyze..."
          ANALYZE_OUTPUT=$(flutter analyze 2>&1) || true
          echo "$ANALYZE_OUTPUT"
          
          # Count issue types
          ERRORS=$(echo "$ANALYZE_OUTPUT" | grep -c "error ‚Ä¢" || echo "0")
          WARNINGS=$(echo "$ANALYZE_OUTPUT" | grep -c "warning ‚Ä¢" || echo "0")
          INFOS=$(echo "$ANALYZE_OUTPUT" | grep -c "info ‚Ä¢" || echo "0")
          TOTAL=$(echo "$ANALYZE_OUTPUT" | grep -oP '\d+(?= issues found)' || echo "0")
          
          echo ""
          echo "üìä Analysis Summary:"
          echo "  Total issues: $TOTAL"
          echo "  Errors: $ERRORS"
          echo "  Warnings: $WARNINGS"
          echo "  Info suggestions: $INFOS"
          echo ""
          
          if [ "$ERRORS" -gt 0 ]; then
            echo "‚ùå Found $ERRORS error(s) - please fix these"
            exit 1
          elif [ "$WARNINGS" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $WARNINGS warning(s) - consider addressing these"
          else
            echo "‚ÑπÔ∏è Found $INFOS info-level suggestions (non-blocking)"
            echo "üí° Tip: Run 'dart fix --apply' to auto-fix many of these"
          fi

      - name: Run dart_code_metrics
        continue-on-error: true
        run: |
          echo "üìä Running dart_code_metrics..."
          dart run dart_code_metrics:metrics analyze lib --reporter=console || {
            echo "‚ö†Ô∏è Code metrics analysis completed with warnings"
          }

      - name: Print complexity warnings
        continue-on-error: true
        run: |
          echo "üìà Checking code complexity..."
          dart run dart_code_metrics:metrics analyze lib --reporter=console --set-exit-on-warnings=false 2>&1 | grep -i "complexity\|cyclomatic" || echo "No complexity warnings found"

      - name: Print file size warnings
        continue-on-error: true
        run: |
          echo "üìè Checking file sizes..."
          find lib -name "*.dart" -type f | while read file; do
            LINES=$(wc -l < "$file" | tr -d ' ')
            if [ "$LINES" -gt 500 ]; then
              echo "‚ö†Ô∏è Large file detected: $file ($LINES lines) - Consider splitting"
            fi
          done

