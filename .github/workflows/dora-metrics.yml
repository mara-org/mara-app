# Mara DevOps â€“ DORA Metrics
# Tracks deployment frequency, lead time, and change failure rate
# Frontend-only: analyzes GitHub Actions history for metrics

name: Mara DevOps â€“ DORA Metrics

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  dora-metrics:
    name: Calculate DORA Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate DORA metrics
        id: dora
        run: |
          echo "ðŸ“Š Calculating DORA metrics..."
          
          # Time window: last 30 days
          DAYS=30
          END_DATE=$(date -u +"%Y-%m-%d")
          START_DATE=$(date -u -d "$DAYS days ago" +"%Y-%m-%d")
          
          echo "Time window: $START_DATE to $END_DATE"
          
          # Get deployment events (workflow runs for deploy workflows)
          DEPLOY_WORKFLOWS=("frontend-deploy.yml" "staging-deploy.yml")
          DEPLOY_COUNT=0
          
          for workflow in "${DEPLOY_WORKFLOWS[@]}"; do
            # Count successful deployments in last 30 days
            COUNT=$(gh run list --workflow="$workflow" --status=success --limit=100 --json createdAt --jq ".[] | select(.createdAt >= \"$START_DATE\") | .createdAt" 2>/dev/null | wc -l || echo "0")
            DEPLOY_COUNT=$((DEPLOY_COUNT + COUNT))
          done
          
          # Deployment frequency (deployments per day)
          if [ "$DEPLOY_COUNT" -gt 0 ]; then
            DEPLOY_FREQUENCY=$(echo "scale=2; $DEPLOY_COUNT / $DAYS" | bc || echo "0")
          else
            DEPLOY_FREQUENCY="0"
          fi
          
          # Lead time (time from commit to deployment) - approximate
          # Get average time from commit to deploy workflow completion
          LEAD_TIME_HOURS="N/A"  # Would need more complex analysis
          
          # Change failure rate (failed deployments / total deployments)
          FAILED_DEPLOYS=0
          for workflow in "${DEPLOY_WORKFLOWS[@]}"; do
            COUNT=$(gh run list --workflow="$workflow" --status=failure --limit=100 --json createdAt --jq ".[] | select(.createdAt >= \"$START_DATE\") | .createdAt" 2>/dev/null | wc -l || echo "0")
            FAILED_DEPLOYS=$((FAILED_DEPLOYS + COUNT))
          done
          
          TOTAL_DEPLOYS=$((DEPLOY_COUNT + FAILED_DEPLOYS))
          if [ "$TOTAL_DEPLOYS" -gt 0 ]; then
            CHANGE_FAILURE_RATE=$(echo "scale=2; ($FAILED_DEPLOYS * 100) / $TOTAL_DEPLOYS" | bc || echo "0")
          else
            CHANGE_FAILURE_RATE="0"
          fi
          
          # Mean time to recovery (MTTR) - approximate
          MTTR_HOURS="N/A"  # Would need incident tracking
          
          echo "deploy_count=$DEPLOY_COUNT" >> $GITHUB_OUTPUT
          echo "deploy_frequency=$DEPLOY_FREQUENCY" >> $GITHUB_OUTPUT
          echo "change_failure_rate=$CHANGE_FAILURE_RATE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“Š DORA Metrics Summary (Last $DAYS days):"
          echo "  Deployment Frequency: $DEPLOY_FREQUENCY deployments/day"
          echo "  Total Deployments: $DEPLOY_COUNT"
          echo "  Change Failure Rate: $CHANGE_FAILURE_RATE%"
          echo "  Lead Time: $LEAD_TIME_HOURS (requires detailed tracking)"
          echo "  MTTR: $MTTR_HOURS (requires incident tracking)"

      - name: Generate DORA metrics report
        run: |
          mkdir -p docs/metrics
          
          cat > docs/metrics/dora-metrics.md << EOF
          # DORA Metrics Report
          
          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Metrics (Last 30 Days)
          
          | Metric | Value |
          |--------|-------|
          | Deployment Frequency | ${{ steps.dora.outputs.deploy_frequency }} deployments/day |
          | Total Deployments | ${{ steps.dora.outputs.deploy_count }} |
          | Change Failure Rate | ${{ steps.dora.outputs.change_failure_rate }}% |
          | Lead Time | N/A (requires detailed tracking) |
          | Mean Time to Recovery (MTTR) | N/A (requires incident tracking) |
          
          ## Notes
          
          - These metrics are calculated from GitHub Actions workflow runs
          - Lead time and MTTR require more detailed tracking (consider adding to deployment workflows)
          - Metrics are updated daily via scheduled workflow
          
          ## DORA Metrics Targets
          
          - **Elite:** >1 deployment/day, <15% failure rate
          - **High:** 1 deployment/week - 1/day, 15-30% failure rate
          - **Medium:** 1 deployment/month - 1/week, 30-45% failure rate
          - **Low:** <1 deployment/month, >45% failure rate
          EOF
          
          cat docs/metrics/dora-metrics.md

      - name: Commit DORA metrics report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add docs/metrics/dora-metrics.md
          git commit -m "docs: update DORA metrics report" || {
            echo "No changes to commit"
            exit 0
          }
          
          git push origin HEAD:${{ github.ref_name }} || {
            echo "Failed to push (may require manual merge)"
            exit 0
          }

