name: Mara Frontend (Flutter) - Build & Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy-frontend:
    runs-on: ubuntu-latest

    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_FRONTEND }}
      ENVIRONMENT: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"

      - name: Flutter pub get
        run: flutter pub get

      - name: Extract app version
        run: |
          if grep -q '^version:' pubspec.yaml; then
            VERSION_LINE=$(grep '^version:' pubspec.yaml | head -n 1)
            VERSION_VALUE=$(echo "$VERSION_LINE" | awk '{print $2}')
          else
            VERSION_VALUE="unknown"
          fi
          echo "APP_VERSION=$VERSION_VALUE" >> $GITHUB_ENV

      - name: Mark start time
        run: echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Build Flutter APK
        run: flutter build apk --release

      # - name: Build Flutter Web
      #   run: flutter build web --release

      - name: Deploy Flutter build
        run: |
          echo "Deploying Flutter build..."
          # TODO: add your deploy command here
          echo "Done."

      - name: Compute deploy duration
        run: |
          END_TIME=$(date +%s)
          START_TIME=${DEPLOY_START_TIME:-$END_TIME}
          DURATION=$((END_TIME - START_TIME))
          echo "DEPLOY_DURATION=$DURATION" >> $GITHUB_ENV

      - name: Notify Discord - Success
        if: success()
        run: |
          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          MESSAGE="✅ **Mara Frontend Build & Deploy Succeeded**\n\
Environment: \`${ENVIRONMENT}\`\n\
Version: \`${APP_VERSION}\`\n\
Repo: \`${GITHUB_REPOSITORY}\`\n\
Branch: \`${GITHUB_REF_NAME}\`\n\
Actor: \`${GITHUB_ACTOR}\`\n\
Commit: [\`${GITHUB_SHA::7}\`](${COMMIT_URL})\n\
Total time: \`${DEPLOY_DURATION}s\`\n\
Workflow: ${RUN_URL}"

          PAYLOAD=$(printf '{"content": "%s"}' "$MESSAGE")

          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               -X POST "$DISCORD_WEBHOOK"

      - name: Notify Discord - Failure
        if: failure()
        run: |
          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          MESSAGE="❌ **Mara Frontend Build or Deploy FAILED**\n\
Environment: \`${ENVIRONMENT}\`\n\
Version: \`${APP_VERSION}\`\n\
Repo: \`${GITHUB_REPOSITORY}\`\n\
Branch: \`${GITHUB_REF_NAME}\`\n\
Actor: \`${GITHUB_ACTOR}\`\n\
Commit: [\`${GITHUB_SHA::7}\`](${COMMIT_URL})\n\
Total time (if computed): \`${DEPLOY_DURATION:-unknown}s\`\n\
Workflow: ${RUN_URL}\n\
> Check the CI/CD logs."

          PAYLOAD=$(printf '{"content": "%s"}' "$MESSAGE")

          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               -X POST "$DISCORD_WEBHOOK"