name: Mara Frontend - Build & Deploy

on:
  push:
    branches:
      - main         # Change this if you deploy from another branch
  workflow_dispatch: # Allow manual trigger from the Actions tab

jobs:
  build-and-deploy-frontend:
    runs-on: ubuntu-latest

    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_FRONTEND }}
      ENVIRONMENT: production  # Change to "staging" if needed

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd mara-app
          npm install

      - name: Extract frontend version
        run: |
          # Read version from package.json (fallback to 'unknown')
          if [ -f "package.json" ]; then
            VERSION_VALUE=$(node -p "require('./package.json').version || 'unknown'")
          else
            VERSION_VALUE="unknown"
          fi
          echo "APP_VERSION=${VERSION_VALUE}" >> $GITHUB_ENV
          echo "Frontend version detected: ${VERSION_VALUE}"

      - name: Mark build/deploy start time
        run: |
          # Store start time (seconds since epoch)
          echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Build frontend
        run: |
          echo "Building frontend for ${ENVIRONMENT}..."
          npm run build

      - name: Deploy frontend
        run: |
          echo "Deploying frontend..."
          # TODO: Replace this with your real deployment commands
          # Example: rsync build folder to your server:
          # rsync -avz build/ user@server:/var/www/mara-frontend
          echo "Frontend deployment script finished."

      - name: Compute deploy duration
        run: |
          END_TIME=$(date +%s)
          START_TIME=${DEPLOY_START_TIME:-$END_TIME}
          DURATION=$((END_TIME - START_TIME))
          if [ "$DURATION" -lt 0 ]; then
            DURATION=0
          fi
          echo "DEPLOY_DURATION=${DURATION}" >> $GITHUB_ENV
          echo "Frontend build + deploy duration: ${DURATION} seconds"

      - name: Notify Discord - Success
        if: success()
        run: |
          echo "Sending success notification to Discord..."
          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          MESSAGE="✅ **Mara Frontend Build & Deploy Succeeded\nEnvironment:** \`${ENVIRONMENT}\`\n**Version:** \`${APP_VERSION}\`\n**Repo:** \`${GITHUB_REPOSITORY}\`\n**Branch:** \`${GITHUB_REF_NAME}\`\n**Actor:** \`${GITHUB_ACTOR}\`\n**Commit:** [\`${GITHUB_SHA::7}\`](${COMMIT_URL})\n**Total time:** \`${DEPLOY_DURATION}s\`\n**Workflow Run:** ${RUN_URL}"

          JSON_PAYLOAD=$(printf '{"content": "%s"}' "$MESSAGE")

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "$DISCORD_WEBHOOK"

      - name: Notify Discord - Failure
        if: failure()
        run: |
          echo "Sending failure notification to Discord..."
          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          MESSAGE="❌ **Mara Frontend Build or Deploy FAILED\nEnvironment:** \`${ENVIRONMENT}\`\n**Version:** \`${APP_VERSION}\`\n**Repo:** \`${GITHUB_REPOSITORY}\`\n**Branch:** \`${GITHUB_REF_NAME}\`\n**Actor:** \`${GITHUB_ACTOR}\`\n**Commit:** [\`${GITHUB_SHA::7}\`](${COMMIT_URL})\n**Total time (if computed):** \`${DEPLOY_DURATION:-unknown}s\`\n**Workflow Run:** ${RUN_URL}\n> Please check the frontend CI/CD logs."

          JSON_PAYLOAD=$(printf '{"content": "%s"}' "$MESSAGE")

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$JSON_PAYLOAD" \
               "$DISCORD_WEBHOOK"