name: Mara Frontend (Flutter) - Build & Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy-frontend:
    runs-on: ubuntu-latest

    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_DEPLOYS }}
      ENVIRONMENT: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure Discord webhook exists
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "❌ ERROR: DISCORD_WEBHOOK_DEPLOYS secret not found!"
            exit 1
          else
            echo "✅ Webhook loaded successfully."
          fi

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.0"

      - name: Flutter pub get
        run: flutter pub get

      - name: Extract app version
        run: |
          if grep -q '^version:' pubspec.yaml; then
            VERSION_LINE=$(grep '^version:' pubspec.yaml | head -n 1)
            VERSION_VALUE=$(echo "$VERSION_LINE" | awk '{print $2}')
          else
            VERSION_VALUE="unknown"
          fi
          echo "APP_VERSION=$VERSION_VALUE" >> $GITHUB_ENV

      - name: Mark start time
        run: echo "DEPLOY_START=$(date +%s)" >> $GITHUB_ENV

      - name: Build Flutter APK
        run: flutter build apk --release

      - name: Deploy build (placeholder)
        run: |
          echo "Uploading build (placeholder)..."
          echo "Done."

      - name: Compute duration
        run: |
          END=$(date +%s)
          START=${DEPLOY_START:-$END}
          DURATION=$((END - START))
          echo "DEPLOY_DURATION=$DURATION" >> $GITHUB_ENV

      - name: Notify Discord (final)
        if: always()
        run: |
          STATUS="${{ job.status }}"
          ICON="✅"
          TITLE="Mara Frontend Deploy Succeeded"
          if [ "$STATUS" != "success" ]; then
            ICON="❌"
            TITLE="Mara Frontend Deploy FAILED"
          fi

          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          MESSAGE="${ICON} **${TITLE}**
Env: \`${ENVIRONMENT}\`
Version: \`${APP_VERSION}\`
Status: \`${STATUS}\`
Repo: \`${GITHUB_REPOSITORY}\`
Branch: \`${GITHUB_REF_NAME}\`
Actor: \`${GITHUB_ACTOR}\`
Commit: [\`${GITHUB_SHA::7}\`](${COMMIT_URL})
Duration: \`${DEPLOY_DURATION}s\`
Workflow: ${RUN_URL}"

          echo "$MESSAGE" > /tmp/msg.txt
          PAYLOAD=$(python3 -c "import json;print(json.dumps({'content':open('/tmp/msg.txt').read()}))")

          curl -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            -X POST "$DISCORD_WEBHOOK"