# Mara SRE â€“ Repeated Failures Alert
# Monitors CI/CD workflows and alerts when failures occur repeatedly
# Alerts if 3+ failures in recent runs OR 2+ consecutive failures

name: Mara SRE â€“ Repeated Failures Alert

on:
  workflow_run:
    workflows: ["Mara CI â€“ Multi Platform", "Mara CD â€“ Deploy APK"]
    types:
      - completed

jobs:
  detect-repeated-failures:
    name: Detect Repeated Failures
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_ALERTS }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect repeated failures
        id: check_failures
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          WORKFLOW_ID="${{ github.event.workflow_run.workflow_id }}"
          
          echo "Checking for repeated failures in workflow: $WORKFLOW_NAME"
          echo "Branch: $BRANCH"
          echo "Workflow ID: $WORKFLOW_ID"
          
          # Use GitHub API to get recent workflow runs
          API_URL="https://api.github.com/repos/${{ github.repository }}/actions/workflows/${WORKFLOW_ID}/runs?branch=${BRANCH}&per_page=5"
          
          echo "Fetching recent runs from: $API_URL"
          
          # Get workflow runs using curl
          RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$API_URL")
          
          # Count failures using jq (available in GitHub Actions)
          FAILURE_COUNT=$(echo "$RESPONSE" | jq '[.workflow_runs[] | select(.conclusion == "failure")] | length' || echo "0")
          
          # Check consecutive failures (first 2 runs)
          CONSECUTIVE_FAILURES=$(echo "$RESPONSE" | jq '[.workflow_runs[0:2][] | select(.conclusion == "failure")] | length' || echo "0")
          
          echo "Failure count: $FAILURE_COUNT"
          echo "Consecutive failures: $CONSECUTIVE_FAILURES"
          
          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT
          echo "consecutive_failures=$CONSECUTIVE_FAILURES" >> $GITHUB_OUTPUT
          
          # Alert if 3+ failures in recent runs OR 2+ consecutive failures
          if [ "$FAILURE_COUNT" -ge 3 ] || [ "$CONSECUTIVE_FAILURES" -ge 2 ]; then
            echo "should_alert=true" >> $GITHUB_OUTPUT
            echo "alert_reason=repeated_failures" >> $GITHUB_OUTPUT
          else
            echo "should_alert=false" >> $GITHUB_OUTPUT
          fi

      - name: Send alert for repeated failures
        if: steps.check_failures.outputs.should_alert == 'true'
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          RUN_URL="${{ github.event.workflow_run.html_url }}"
          FAILURE_COUNT="${{ steps.check_failures.outputs.failure_count }}"
          CONSECUTIVE="${{ steps.check_failures.outputs.consecutive_failures }}"
          
          MESSAGE="ðŸš¨ **Repeated Failure Alert**
          
          Workflow: \`${WORKFLOW_NAME}\`
          Branch: \`${BRANCH}\`
          Recent failures: \`${FAILURE_COUNT}\`
          Consecutive failures: \`${CONSECUTIVE}\`
          
          This workflow has failed multiple times recently. Please investigate.
          
          Latest run: ${RUN_URL}"
          
          # Check if webhook is set
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "âš ï¸ DISCORD_WEBHOOK_ALERTS secret is not set. Skipping alert."
            exit 0
          fi
          
          # Create JSON payload
          echo "$MESSAGE" > /tmp/alert_msg.txt
          PAYLOAD=$(python3 -c "import json; f=open('/tmp/alert_msg.txt'); msg=f.read(); f.close(); print(json.dumps({'content': msg}))")
          
          # Send to Discord
          HTTP_CODE=$(curl -s -o /tmp/discord_response.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            -X POST "$DISCORD_WEBHOOK" 2>/dev/null)
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
            echo "âœ… Alert sent successfully (HTTP $HTTP_CODE)"
          else
            echo "âš ï¸ Failed to send alert (HTTP $HTTP_CODE)"
            cat /tmp/discord_response.txt 2>/dev/null || echo "No response"
          fi

