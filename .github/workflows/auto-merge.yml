# Mara Automation ‚Äì Auto Merge
# Automatically merges PRs when conditions are met:
# - CI checks pass
# - Required approvals (1-2)
# - Label 'auto-merge' is present
# - No conflicts

name: Mara Automation ‚Äì Auto Merge

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]
  check_suite:
    types: [completed]
  status: {}

jobs:
  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.state == 'open'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PR author and labels
        id: check_pr
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_AUTHOR=$(gh pr view "$PR_NUMBER" --json author --jq '.author.login' || echo "")
          LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' || echo "")
          
          echo "PR Author: $PR_AUTHOR"
          echo "Labels: $LABELS"
          
          # Check if auto-merge label exists
          if echo "$LABELS" | grep -q "auto-merge"; then
            echo "‚úÖ auto-merge label found"
            echo "has_label=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è auto-merge label not found"
            echo "has_label=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if PR is from Dependabot or has dependencies label
          IS_DEPENDABOT=false
          HAS_DEPENDENCIES_LABEL=false
          
          if [ "$PR_AUTHOR" = "dependabot[bot]" ]; then
            echo "‚úÖ PR is from Dependabot"
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
            IS_DEPENDABOT=true
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$LABELS" | grep -qi "dependencies"; then
            echo "‚úÖ PR has 'dependencies' label"
            echo "has_dependencies_label=true" >> $GITHUB_OUTPUT
            HAS_DEPENDENCIES_LABEL=true
          else
            echo "has_dependencies_label=false" >> $GITHUB_OUTPUT
          fi
          
          # Auto-merge is allowed if:
          # 1. Has auto-merge label, OR
          # 2. Is Dependabot/dependencies PR with all checks passing
          if [ "$IS_DEPENDABOT" = "true" ] || [ "$HAS_DEPENDENCIES_LABEL" = "true" ]; then
            echo "‚úÖ PR qualifies for auto-merge (Dependabot or dependencies label)"
            echo "can_auto_merge=true" >> $GITHUB_OUTPUT
          elif [ "${{ steps.check_pr.outputs.has_label }}" = "true" ]; then
            echo "‚úÖ PR qualifies for auto-merge (has auto-merge label)"
            echo "can_auto_merge=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è PR does not qualify for auto-merge"
            echo "can_auto_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Check CI and security status
        id: check_ci
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Get PR status checks
          STATUSES=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '.statusCheckRollup[] | select(.conclusion != null) | .conclusion' || echo "")
          
          # Check for failures
          if echo "$STATUSES" | grep -q "FAILURE"; then
            echo "‚ùå Some CI checks failed"
            echo "ci_passed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for pending
          if echo "$STATUSES" | grep -q "PENDING"; then
            echo "‚è≥ CI checks still pending"
            echo "ci_passed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check specifically for security-pr-check status
          SECURITY_STATUS=$(gh pr checks "$PR_NUMBER" --json name,conclusion --jq '.[] | select(.name == "Security PR Check") | .conclusion' || echo "")
          
          if [ "$SECURITY_STATUS" = "FAILURE" ]; then
            echo "‚ùå Security PR Check failed - blocking auto-merge"
            echo "ci_passed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "‚úÖ All CI and security checks passed"
          echo "ci_passed=true" >> $GITHUB_OUTPUT

      - name: Check approvals
        id: check_approvals
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          IS_DEPENDABOT="${{ steps.check_pr.outputs.is_dependabot }}"
          HAS_DEPENDENCIES_LABEL="${{ steps.check_pr.outputs.has_dependencies_label }}"
          
          # Get approval count
          APPROVALS=$(gh pr view "$PR_NUMBER" --json reviews --jq '[.reviews[] | select(.state == "APPROVED")] | length' || echo "0")
          
          echo "Approvals: $APPROVALS"
          echo "approval_count=$APPROVALS" >> $GITHUB_OUTPUT
          
          # For Dependabot/dependencies PRs: allow auto-merge with 0 approvals if trivial
          # For other PRs: require at least 1 approval
          if [ "$IS_DEPENDABOT" = "true" ] || [ "$HAS_DEPENDENCIES_LABEL" = "true" ]; then
            # Check if PR only touches pubspec.yaml/pubspec.lock (trivial dependency update)
            CHANGED_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path' || echo "")
            NON_DEPENDENCY_FILES=$(echo "$CHANGED_FILES" | grep -v "pubspec.yaml" | grep -v "pubspec.lock" | grep -v "^$" || true)
            
            if [ -z "$NON_DEPENDENCY_FILES" ]; then
              echo "‚úÖ Trivial dependency-only PR - approval not required"
              echo "has_approvals=true" >> $GITHUB_OUTPUT
            elif [ "$APPROVALS" -ge 1 ]; then
              echo "‚úÖ Required approvals met"
              echo "has_approvals=true" >> $GITHUB_OUTPUT
            else
              echo "‚è≥ Waiting for at least 1 approval"
              echo "has_approvals=false" >> $GITHUB_OUTPUT
            fi
          elif [ "$APPROVALS" -ge 1 ]; then
            echo "‚úÖ Required approvals met"
            echo "has_approvals=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≥ Waiting for approvals (need at least 1)"
            echo "has_approvals=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for conflicts
        id: check_conflicts
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Check if PR has merge conflicts
          MERGEABLE=$(gh pr view "$PR_NUMBER" --json mergeable --jq '.mergeable' || echo "false")
          
          if [ "$MERGEABLE" = "true" ]; then
            echo "‚úÖ No merge conflicts"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          else
            echo "‚ùå PR has merge conflicts"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
          fi

      - name: Auto merge PR
        if: |
          steps.check_pr.outputs.can_auto_merge == 'true' &&
          steps.check_ci.outputs.ci_passed == 'true' &&
          steps.check_approvals.outputs.has_approvals == 'true' &&
          steps.check_conflicts.outputs.has_conflicts == 'false'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "üöÄ Auto-merging PR #$PR_NUMBER"
          
          # Merge PR (squash merge by default)
          gh pr merge "$PR_NUMBER" --squash --delete-branch || {
            echo "‚ùå Failed to merge PR"
            exit 1
          }
          
          echo "‚úÖ PR #$PR_NUMBER merged successfully"

      - name: Comment if conditions not met
        if: |
          steps.check_pr.outputs.can_auto_merge == 'true' &&
          (steps.check_ci.outputs.ci_passed != 'true' ||
           steps.check_approvals.outputs.has_approvals != 'true' ||
           steps.check_conflicts.outputs.has_conflicts == 'true')
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          REASONS=""
          if [ "${{ steps.check_ci.outputs.ci_passed }}" != "true" ]; then
            REASONS="${REASONS}- ‚è≥ CI checks not passing\n"
          fi
          if [ "${{ steps.check_approvals.outputs.has_approvals }}" != "true" ]; then
            REASONS="${REASONS}- ‚è≥ Waiting for approvals (need at least 1)\n"
          fi
          if [ "${{ steps.check_conflicts.outputs.has_conflicts }}" == "true" ]; then
            REASONS="${REASONS}- ‚ùå Merge conflicts detected\n"
          fi
          
          COMMENT="ü§ñ **Auto-merge pending**\n\nThis PR has the \`auto-merge\` label but cannot be merged yet:\n\n${REASONS}\n\nOnce all conditions are met, this PR will be automatically merged."
          
          gh pr comment "$PR_NUMBER" --body "$COMMENT" || echo "Failed to add comment"

