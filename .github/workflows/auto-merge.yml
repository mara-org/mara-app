# Mara Automation ‚Äì Auto Merge
# Automatically merges PRs when conditions are met:
# - CI checks pass
# - Required approvals (1-2)
# - Label 'auto-merge' is present
# - No conflicts

name: Mara Automation ‚Äì Auto Merge

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]
  check_suite:
    types: [completed]
  status: {}

jobs:
  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.state == 'open'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if auto-merge label exists
        id: check_label
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' || echo "")
          
          if echo "$LABELS" | grep -q "auto-merge"; then
            echo "‚úÖ auto-merge label found"
            echo "has_label=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≠Ô∏è auto-merge label not found, skipping"
            echo "has_label=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Check CI status
        id: check_ci
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Get PR status
          STATUS=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '.statusCheckRollup[] | select(.conclusion != null) | .conclusion' || echo "")
          
          # Check if all checks passed
          if echo "$STATUS" | grep -q "FAILURE"; then
            echo "‚ùå Some CI checks failed"
            echo "ci_passed=false" >> $GITHUB_OUTPUT
            exit 0
          elif echo "$STATUS" | grep -q "PENDING"; then
            echo "‚è≥ CI checks still pending"
            echo "ci_passed=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "‚úÖ All CI checks passed"
            echo "ci_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Check approvals
        id: check_approvals
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Get approval count
          APPROVALS=$(gh pr view "$PR_NUMBER" --json reviews --jq '[.reviews[] | select(.state == "APPROVED")] | length' || echo "0")
          
          echo "Approvals: $APPROVALS"
          echo "approval_count=$APPROVALS" >> $GITHUB_OUTPUT
          
          # Require at least 1 approval (can be increased to 2)
          if [ "$APPROVALS" -ge 1 ]; then
            echo "‚úÖ Required approvals met"
            echo "has_approvals=true" >> $GITHUB_OUTPUT
          else
            echo "‚è≥ Waiting for approvals (need at least 1)"
            echo "has_approvals=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for conflicts
        id: check_conflicts
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Check if PR has merge conflicts
          MERGEABLE=$(gh pr view "$PR_NUMBER" --json mergeable --jq '.mergeable' || echo "false")
          
          if [ "$MERGEABLE" = "true" ]; then
            echo "‚úÖ No merge conflicts"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          else
            echo "‚ùå PR has merge conflicts"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
          fi

      - name: Auto merge PR
        if: |
          steps.check_label.outputs.has_label == 'true' &&
          steps.check_ci.outputs.ci_passed == 'true' &&
          steps.check_approvals.outputs.has_approvals == 'true' &&
          steps.check_conflicts.outputs.has_conflicts == 'false'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "üöÄ Auto-merging PR #$PR_NUMBER"
          
          # Merge PR (squash merge by default)
          gh pr merge "$PR_NUMBER" --squash --delete-branch || {
            echo "‚ùå Failed to merge PR"
            exit 1
          }
          
          echo "‚úÖ PR #$PR_NUMBER merged successfully"

      - name: Comment if conditions not met
        if: |
          steps.check_label.outputs.has_label == 'true' &&
          (steps.check_ci.outputs.ci_passed != 'true' ||
           steps.check_approvals.outputs.has_approvals != 'true' ||
           steps.check_conflicts.outputs.has_conflicts == 'true')
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          REASONS=""
          if [ "${{ steps.check_ci.outputs.ci_passed }}" != "true" ]; then
            REASONS="${REASONS}- ‚è≥ CI checks not passing\n"
          fi
          if [ "${{ steps.check_approvals.outputs.has_approvals }}" != "true" ]; then
            REASONS="${REASONS}- ‚è≥ Waiting for approvals (need at least 1)\n"
          fi
          if [ "${{ steps.check_conflicts.outputs.has_conflicts }}" == "true" ]; then
            REASONS="${REASONS}- ‚ùå Merge conflicts detected\n"
          fi
          
          COMMENT="ü§ñ **Auto-merge pending**\n\nThis PR has the \`auto-merge\` label but cannot be merged yet:\n\n${REASONS}\n\nOnce all conditions are met, this PR will be automatically merged."
          
          gh pr comment "$PR_NUMBER" --body "$COMMENT" || echo "Failed to add comment"

